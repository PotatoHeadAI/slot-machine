// å¨±ä¹è€è™æœºæ¸¸æˆ - ä¸»é€»è¾‘
class SlotMachineGame {
    constructor() {
        this.gameState = {
            coins: 1000,
            betAmount: 100,
            gamesPlayed: 0,
            gamesWon: 0,
            winStreak: 0,
            maxStreak: 0,
            totalWinnings: 0,
            maxWin: 0,
            playTime: 0, // åˆ†é’Ÿ
            achievements: {},
            soundEnabled: true
        };
        
        this.symbols = [
            { emoji: 'ğŸ’', name: 'æ¨±æ¡ƒ', multiplier: 3 },
            { emoji: 'ğŸ‹', name: 'æŸ æª¬', multiplier: 5 },
            { emoji: 'ğŸŠ', name: 'æ©™å­', multiplier: 7 },
            { emoji: 'â­', name: 'æ˜Ÿæ˜Ÿ', multiplier: 10 },
            { emoji: 'ğŸ””', name: 'é“ƒé“›', multiplier: 15 },
            { emoji: '7ï¸âƒ£', name: 'å¹¸è¿7', multiplier: 20 },
            { emoji: 'ğŸ°', name: 'è€è™æœº', multiplier: 25 },
            { emoji: 'ğŸ‘‘', name: 'çš‡å† ', multiplier: 30 }
        ];
        
        this.achievementsList = [
            { id: 'first_win', name: 'é¦–èƒœ', desc: 'èµ¢å¾—ç¬¬ä¸€æ¬¡æ¸¸æˆ', icon: 'ğŸ¥‡', points: 10 },
            { id: 'big_winner', name: 'å¤§èµ¢å®¶', desc: 'å•æ¬¡èµ¢å¾—500è™šæ‹Ÿå¸', icon: 'ğŸ’°', points: 20 },
            { id: 'streak_master', name: 'è¿èƒœå¤§å¸ˆ', desc: 'è¾¾æˆ5è¿èƒœ', icon: 'ğŸ”¥', points: 30 },
            { id: 'veteran', name: 'è€ç©å®¶', desc: 'æ¸¸ç©50æ¬¡æ¸¸æˆ', icon: 'ğŸ®', points: 25 },
            { id: 'jackpot', name: 'å¤´å¥–', desc: 'ä¸­å¾—æœ€é«˜å€æ•°', icon: 'ğŸ¯', points: 50 },
            { id: 'collector', name: 'æ”¶è—å®¶', desc: 'è§£é”æ‰€æœ‰æˆå°±', icon: 'ğŸ†', points: 100 }
        ];
        
        this.isSpinning = false;
        this.spinTimeout = null;
        this.playTimer = null;
        
        this.initElements();
        this.initEventListeners();
        this.initReels();
        this.loadGameState();
        this.updateDisplay();
        this.startPlayTimer();
    }
    
    initElements() {
        // è·å–DOMå…ƒç´ 
        this.reel1 = document.getElementById('reel1');
        this.reel2 = document.getElementById('reel2');
        this.reel3 = document.getElementById('reel3');
        this.spinButton = document.getElementById('spin-btn');
        this.coinCount = document.getElementById('coin-count');
        this.currentCoins = document.getElementById('current-coins');
        this.winStreak = document.getElementById('win-streak');
        this.gamesPlayed = document.getElementById('games-played');
        this.winRate = document.getElementById('win-rate');
        this.resultDisplay = document.getElementById('result-display');
        this.lastWin = document.getElementById('last-win');
        this.achievementsGrid = document.getElementById('achievements-grid');
        this.playTime = document.getElementById('play-time');
        this.maxWin = document.getElementById('max-win');
        this.maxStreak = document.getElementById('max-streak');
        this.achievementPoints = document.getElementById('achievement-points');
        this.jackpot = document.getElementById('jackpot');
        
        // éŸ³æ•ˆ
        this.spinSound = document.getElementById('spin-sound');
        this.winSound = document.getElementById('win-sound');
        this.coinSound = document.getElementById('coin-sound');
        
        // æ§åˆ¶æŒ‰é’®
        this.betButtons = document.querySelectorAll('.bet-btn');
        this.resetButton = document.getElementById('reset-btn');
        this.soundButton = document.getElementById('sound-btn');
        this.helpButton = document.getElementById('help-btn');
        this.shareButton = document.getElementById('share-btn');
        
        // æ¨¡æ€æ¡†
        this.helpModal = document.getElementById('help-modal');
        this.closeModalButton = this.helpModal.querySelector('.close-modal');
    }
    
    initEventListeners() {
        // æ—‹è½¬æŒ‰é’®
        this.spinButton.addEventListener('click', () => this.spin());
        
        // æŠ•æ³¨æŒ‰é’®
        this.betButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const bet = parseInt(e.target.dataset.bet);
                this.setBetAmount(bet);
            });
        });
        
        // æ§åˆ¶æŒ‰é’®
        this.resetButton.addEventListener('click', () => this.resetGame());
        this.soundButton.addEventListener('click', () => this.toggleSound());
        this.helpButton.addEventListener('click', () => this.showHelp());
        this.shareButton.addEventListener('click', () => this.shareGame());
        
        // æ¨¡æ€æ¡†
        this.closeModalButton.addEventListener('click', () => this.hideHelp());
        this.helpModal.addEventListener('click', (e) => {
            if (e.target === this.helpModal) this.hideHelp();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                this.spin();
            }
            if (e.key === 'Escape' && this.helpModal.classList.contains('active')) {
                this.hideHelp();
            }
        });
    }
    
    initReels() {
        // åˆå§‹åŒ–ä¸‰ä¸ªè½¬è½®çš„ç¬¦å·
        this.createReelStrip(this.reel1);
        this.createReelStrip(this.reel2);
        this.createReelStrip(this.reel3);
    }
    
    createReelStrip(reelElement) {
        const strip = reelElement.querySelector('.reel-strip');
        strip.innerHTML = '';
        
        // åˆ›å»ºå¤šä¸ªç¬¦å·å®ä¾‹ï¼ˆç¡®ä¿æœ‰è¶³å¤Ÿçš„ç¬¦å·ç”¨äºæ»šåŠ¨ï¼‰
        for (let i = 0; i < 20; i++) {
            const symbol = this.getRandomSymbol();
            const symbolElement = document.createElement('div');
            symbolElement.className = 'symbol';
            symbolElement.innerHTML = symbol.emoji;
            symbolElement.dataset.name = symbol.name;
            symbolElement.dataset.multiplier = symbol.multiplier;
            strip.appendChild(symbolElement);
        }
    }
    
    getRandomSymbol() {
        // åŠ æƒéšæœº - é«˜å€ç‡ç¬¦å·å‡ºç°æ¦‚ç‡æ›´ä½
        const weights = [30, 25, 20, 15, 10, 5, 3, 2]; // å¯¹åº”8ä¸ªç¬¦å·
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let random = Math.random() * totalWeight;
        
        for (let i = 0; i < this.symbols.length; i++) {
            random -= weights[i];
            if (random <= 0) {
                return this.symbols[i];
            }
        }
        
        return this.symbols[0]; // é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ª
    }
    
    setBetAmount(amount) {
        if (this.isSpinning) return;
        
        this.gameState.betAmount = amount;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        this.betButtons.forEach(btn => {
            if (parseInt(btn.dataset.bet) === amount) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        this.saveGameState();
    }
    
    spin() {
        if (this.isSpinning) return;
        
        // æ£€æŸ¥è™šæ‹Ÿå¸æ˜¯å¦è¶³å¤Ÿ
        if (this.gameState.coins < this.gameState.betAmount) {
            this.showMessage('è™šæ‹Ÿå¸ä¸è¶³ï¼è¯·é‡ç½®æ¸¸æˆæˆ–é™ä½æŠ•æ³¨é¢ã€‚', 'error');
            return;
        }
        
        // æ‰£é™¤æŠ•æ³¨é¢
        this.gameState.coins -= this.gameState.betAmount;
        this.gameState.gamesPlayed++;
        
        // å¼€å§‹æ—‹è½¬
        this.isSpinning = true;
        this.spinButton.classList.add('spinning');
        this.spinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ—‹è½¬ä¸­...';
        
        // æ’­æ”¾éŸ³æ•ˆ
        if (this.gameState.soundEnabled) {
            this.spinSound.currentTime = 0;
            this.spinSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
        }
        
        // æ—‹è½¬åŠ¨ç”»
        this.animateReels(() => {
            // æ—‹è½¬å®Œæˆï¼Œæ£€æŸ¥ç»“æœ
            const results = this.getSpinResults();
            this.processResults(results);
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            this.isSpinning = false;
            this.spinButton.classList.remove('spinning');
            this.spinButton.innerHTML = '<i class="fas fa-play"></i> å¼€å§‹æ—‹è½¬';
            
            // ä¿å­˜æ¸¸æˆçŠ¶æ€
            this.saveGameState();
            this.updateDisplay();
            
            // æ£€æŸ¥æˆå°±
            this.checkAchievements();
        });
    }
    
    animateReels(callback) {
        const reels = [this.reel1, this.reel2, this.reel3];
        const durations = [3000, 3200, 3400]; // æ¯ä¸ªè½¬è½®ä¸åŒçš„æŒç»­æ—¶é—´
        
        let completed = 0;
        
        reels.forEach((reel, index) => {
            const strip = reel.querySelector('.reel-strip');
            const symbolHeight = 100; // æ¯ä¸ªç¬¦å·é«˜åº¦
            const randomOffset = Math.floor(Math.random() * 5) + 10; // éšæœºæ»šåŠ¨è·ç¦»
            
            // é‡ç½®ä½ç½®
            strip.style.transition = 'none';
            strip.style.transform = 'translateY(0)';
            
            // å¼ºåˆ¶é‡ç»˜
            void strip.offsetWidth;
            
            // å¼€å§‹åŠ¨ç”»
            strip.style.transition = `transform ${durations[index]}ms cubic-bezier(0.2, 0.8, 0.3, 1)`;
            strip.style.transform = `translateY(-${randomOffset * symbolHeight}px)`;
            
            // åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                completed++;
                if (completed === reels.length) {
                    setTimeout(callback, 500); // é¢å¤–å»¶è¿Ÿæ˜¾ç¤ºç»“æœ
                }
            }, durations[index]);
        });
    }
    
    getSpinResults() {
        const reels = [this.reel1, this.reel2, this.reel3];
        const results = [];
        
        reels.forEach(reel => {
            const strip = reel.querySelector('.reel-strip');
            const computedStyle = window.getComputedStyle(strip);
            const matrix = new DOMMatrixReadOnly(computedStyle.transform);
            const translateY = matrix.m42;
            
            // è®¡ç®—å½“å‰æ˜¾ç¤ºçš„ç¬¦å·ï¼ˆä¸­é—´ä½ç½®ï¼‰
            const symbolIndex = Math.round(Math.abs(translateY) / 100) % 8;
            const symbols = strip.querySelectorAll('.symbol');
            const currentSymbol = symbols[symbolIndex];
            
            results.push({
                emoji: currentSymbol.innerHTML,
                name: currentSymbol.dataset.name,
                multiplier: parseInt(currentSymbol.dataset.multiplier)
            });
        });
        
        return results;
    }
    
    processResults(results) {
        const [symbol1, symbol2, symbol3] = results;
        
        // æ£€æŸ¥æ˜¯å¦ä¸­å¥–ï¼ˆä¸‰ä¸ªç¬¦å·ç›¸åŒï¼‰
        if (symbol1.name === symbol2.name && symbol2.name === symbol3.name) {
            // ä¸­å¥–ï¼
            const winAmount = this.gameState.betAmount * symbol1.multiplier;
            this.gameState.coins += winAmount;
            this.gameState.gamesWon++;
            this.gameState.winStreak++;
            this.gameState.totalWinnings += winAmount;
            
            // æ›´æ–°æœ€å¤§ä¸­å¥–é¢
            if (winAmount > this.gameState.maxWin) {
                this.gameState.maxWin = winAmount;
            }
            
            // æ›´æ–°æœ€å¤§è¿èƒœ
            if (this.gameState.winStreak > this.gameState.maxStreak) {
                this.gameState.maxStreak = this.gameState.winStreak;
            }
            
            // æ˜¾ç¤ºä¸­å¥–ä¿¡æ¯
            this.showWinMessage(symbol1, winAmount);
            
            // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆ
            if (this.gameState.soundEnabled) {
                this.winSound.currentTime = 0;
                this.winSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
                
                this.coinSound.currentTime = 0;
                this.coinSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
        } else {
            // æœªä¸­å¥–
            this.gameState.winStreak = 0;
            this.showLoseMessage();
        }
    }
    
    showWinMessage(symbol, amount) {
        const resultHTML = `
            <div class="win-result">
                <div class="win-symbols">
                    <div class="win-symbol">${symbol.emoji}</div>
                    <div class="win-symbol">${symbol.emoji}</div>
                    <div class="win-symbol">${symbol.emoji}</div>
                </div>
                <div class="win-info">
                    <h4>ğŸ‰ æ­å–œä¸­å¥–ï¼</h4>
                    <p>${symbol.name} x${symbol.multiplier}</p>
                    <div class="win-amount">+${amount} è™šæ‹Ÿå¸</div>
                </div>
            </div>
        `;
        
        this.resultDisplay.innerHTML = resultHTML;
        this.lastWin.innerHTML = `æœ€è¿‘ä¸­å¥–ï¼š${symbol.name} x${symbol.multiplier} (+${amount})`;
        
        // æ·»åŠ åº†ç¥åŠ¨ç”»
        this.resultDisplay.classList.add('celebrating');
        setTimeout(() => {
            this.resultDisplay.classList.remove('celebrating');
        }, 2000);
    }
    
    showLoseMessage() {
        this.resultDisplay.innerHTML = `
            <div class="lose-result">
                <div class="lose-icon">ğŸ˜¢</div>
                <div class="lose-info">
                    <h4>æœªä¸­å¥–</h4>
                    <p>ä¸‹æ¬¡å¥½è¿ï¼</p>
                </div>
            </div>
        `;
        
        this.lastWin.innerHTML = 'æœ€è¿‘ä¸­å¥–ï¼šæ— ';
    }
    
    showMessage(text, type = 'info') {
        // ç®€å•çš„æ¶ˆæ¯æç¤º
        alert(text); // åœ¨å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨æ›´ä¼˜é›…çš„æç¤ºæ–¹å¼
    }
    
    checkAchievements() {
        const newAchievements = [];
        
        // æ£€æŸ¥å„ä¸ªæˆå°±æ¡ä»¶
        if (!this.gameState.achievements.first_win && this.gameState.gamesWon >= 1) {
            this.gameState.achievements.first_win = true;
            newAchievements.push(this.achievementsList[0]);
        }
        
        if (!this.gameState.achievements.big_winner && this.gameState.maxWin >= 500) {
            this.gameState.achievements.big_winner = true;
            newAchievements.push(this.achievementsList[1]);
        }
        
        if (!this.gameState.achievements.streak_master && this.gameState.maxStreak >= 5) {
            this.gameState.achievements.streak_master = true;
            newAchievements.push(this.achievementsList[2]);
        }
        
        if (!this.gameState.achievements.veteran && this.gameState.gamesPlayed >= 50) {
            this.gameState.achievements.veteran = true;
            newAchievements.push(this.achievementsList[3]);
        }
        
        if (!this.gameState.achievements.jackpot) {
            // æ£€æŸ¥æ˜¯å¦ä¸­å¾—æœ€é«˜å€æ•°ï¼ˆå¹¸è¿7 x30ï¼‰
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è®°å½•æ¯æ¬¡ä¸­å¥–çš„å€æ•°
        }
        
        // å¦‚æœæœ‰æ–°æˆå°±ï¼Œæ˜¾ç¤ºé€šçŸ¥
        if (newAchievements.length > 0) {
            this.showAchievementNotification(newAchievements);
        }
        
        this.updateAchievementsDisplay();
    }
    
    showAchievementNotification(achievements) {
        achievements.forEach(achievement => {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="notification-icon">${achievement.icon}</div>
                <div class="notification-content">
                    <div class="notification-title">æˆå°±è§£é”ï¼</div>
                    <div class="notification-desc">${achievement.name}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.remove();
            }, 3000);
        });
    }
    
    updateAchievementsDisplay() {
        this.achievementsGrid.innerHTML = '';
        
        this.achievementsList.forEach(achievement => {
            const isUnlocked = this.gameState.achievements[achievement.id] || false;
            
            const achievementElement = document.createElement('div');
            achievementElement.className = `achievement ${isUnlocked ? 'unlocked' : 'locked'}`;
            achievementElement.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-desc">${achievement.desc}</div>
                <div class="achievement-points">${achievement.points}ç‚¹</div>
            `;
            
            this.achievementsGrid.appendChild(achievementElement);
        });
        
        // è®¡ç®—æˆå°±ç‚¹æ•°
        const totalPoints = this.achievementsList.reduce((total, achievement) => {
            return total + (this.gameState.achievements[achievement.id] ? achievement.points : 0);
        }, 0);
        
        this.achievementPoints.textContent = totalPoints;
    }
    
    updateDisplay() {
        // æ›´æ–°è™šæ‹Ÿå¸æ˜¾ç¤º
        this.coinCount.textContent = this.gameState.coins;
        this.currentCoins.textContent = this.gameState.coins;
        
        // æ›´æ–°æ¸¸æˆç»Ÿè®¡
        this.winStreak.textContent = this.gameState.winStreak;
        this.gamesPlayed.textContent = this.gameState.gamesPlayed;
        
        // è®¡ç®—èƒœç‡
        const winRate = this.gameState.gamesPlayed > 0 
            ? Math.round((this.gameState.gamesWon / this.gameState.gamesPlayed) * 100) 
            : 0;
        this.winRate.textContent = `${winRate}%`;
        
        // æ›´æ–°å…¶ä»–ç»Ÿè®¡
        this